<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPPKAD Blora - Realisasi APBD 2017-2024</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/supabase.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo">B</div>
                <div class="brand-text">
                    <h1>BPPKAD Blora</h1>
                    <p>Badan Pengelolaan Pendapatan, Keuangan dan Aset Daerah</p>
                </div>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link active">Beranda</a></li>
                <li><a href="pendapatan.html" class="nav-link">Pendapatan</a></li>
                <li><a href="pembelanjaan.html" class="nav-link">Pembelanjaan</a></li>
                <li><a href="pembiayaan.html" class="nav-link">Pembiayaan</a></li>
                <li><a href="admin.html" class="nav-link admin-link">Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1>Realisasi APBD Kabupaten Blora</h1>
            <p class="subtitle">Tahun Anggaran 2017 - 2024</p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-header">
                    <h3>Total Pendapatan</h3>
                </div>
                <div class="card-body">
                    <p class="amount" id="total-pendapatan">Rp 0</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Total Pembelanjaan</h3>
                </div>
                <div class="card-body">
                    <p class="amount" id="total-pembelanjaan">Rp 0</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Total Pembiayaan</h3>
                </div>
                <div class="card-body">
                    <p class="amount" id="total-pembiayaan">Rp 0</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <!-- Summary Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>Ringkasan Realisasi APBD</h2>
                    <p>Perbandingan total realisasi per kategori</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>Tren Realisasi per Tahun</h2>
                    <p>Perkembangan realisasi APBD dari tahun 2017-2024</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-section">
            <h2>Statistik Cepat</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="total-entries">0</div>
                    <div class="stat-label">Total Entri Data</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="year-range">2017-2024</div>
                    <div class="stat-label">Rentang Tahun</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="categories-count">3</div>
                    <div class="stat-label">Kategori Utama</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="subcategories-count">0</div>
                    <div class="stat-label">Subkategori</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 BPPKAD Kabupaten Blora. Semua hak cipta dilindungi.</p>
            <p>Sistem Informasi Realisasi APBD</p>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Memuat data...</p>
    </div>

    <script src="js/supabase.js"></script>
    <script src="js/script.js"></script>
    <script>
        // Initialize homepage
        document.addEventListener('DOMContentLoaded', function() {
            initHomePage();
        });

        async function initHomePage() {
            showLoading();
            try {
                await loadSummaryData();
                await createSummaryCharts();
            } catch (error) {
                console.error('Error loading homepage:', error);
                showError('Gagal memuat data. Periksa koneksi internet Anda.');
            }
            hideLoading();
        }

        async function loadSummaryData() {
            const data = await fetchAllData();
            
            // Calculate totals by category
            const totals = {
                pendapatan: 0,
                pembelanjaan: 0,
                pembiayaan: 0
            };

            let totalEntries = 0;
            const subcategories = new Set();

            data.forEach(item => {
                const kategori = item.kategori.toLowerCase();
                const nilai = parseFloat(item.nilai) || 0;
                
                if (totals.hasOwnProperty(kategori)) {
                    totals[kategori] += nilai;
                }
                
                totalEntries++;
                subcategories.add(item.subkategori);
            });

            // Update UI
            document.getElementById('total-pendapatan').textContent = formatCurrency(totals.pendapatan);
            document.getElementById('total-pembelanjaan').textContent = formatCurrency(totals.pembelanjaan);
            document.getElementById('total-pembiayaan').textContent = formatCurrency(totals.pembiayaan);
            document.getElementById('total-entries').textContent = totalEntries;
            document.getElementById('subcategories-count').textContent = subcategories.size;

            return { totals, data };
        }

        async function createSummaryCharts() {
            const { totals, data } = await loadSummaryData();

            // Create summary chart
            const summaryCtx = document.getElementById('summaryChart').getContext('2d');
            new Chart(summaryCtx, {
                type: 'bar',
                data: {
                    labels: ['Pendapatan', 'Pembelanjaan', 'Pembiayaan'],
                    datasets: [{
                        label: 'Realisasi (Rupiah)',
                        data: [totals.pendapatan, totals.pembelanjaan, totals.pembiayaan],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderColor: ['#1e7e34', '#c82333', '#e0a800'],
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrencyShort(value);
                                }
                            },
                            grid: {
                                color: '#e9ecef'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Create trend chart
            createTrendChart(data);
        }

        function createTrendChart(data) {
            // Group data by year and category
            const yearlyData = {};
            
            data.forEach(item => {
                const year = item.tahun;
                const kategori = item.kategori.toLowerCase();
                const nilai = parseFloat(item.nilai) || 0;
                
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        pendapatan: 0,
                        pembelanjaan: 0,
                        pembiayaan: 0
                    };
                }
                
                if (yearlyData[year].hasOwnProperty(kategori)) {
                    yearlyData[year][kategori] += nilai;
                }
            });

            const years = Object.keys(yearlyData).sort();
            const pendapatanData = years.map(year => yearlyData[year].pendapatan);
            const pembelanjaanData = years.map(year => yearlyData[year].pembelanjaan);
            const pembiayaanData = years.map(year => yearlyData[year].pembiayaan);

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Pendapatan',
                            data: pendapatanData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Pembelanjaan',
                            data: pembelanjaanData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Pembiayaan',
                            data: pembiayaanData,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrencyShort(value);
                                }
                            },
                            grid: {
                                color: '#e9ecef'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
